#!/bin/bash
# /opt/TAK_ADSB/scripts/docker-compose-adsb
# Docker Compose wrapper for TAK-ADSB-Feeder
# Based on adsb.im production implementation

set -e

# Must run as root
if [ "$(id -u)" != "0" ]; then
    echo "Error: This script requires root privileges"
    echo "Usage: sudo $0 [docker-compose arguments]"
    exit 1
fi

BASE_DIR="/opt/TAK_ADSB"
CONFIG_DIR="$BASE_DIR/config"
ENV_FILE="$CONFIG_DIR/.env"
LOCKFILE="$BASE_DIR/docker-starting.lock"

# Identify calling process for logging
PARENTPID=$(ps -cp $$ -o ppid=)
if kill -0 "$PARENTPID" &> /dev/null; then
    PARENTPROC=$(ps -q$PARENTPID -o args=)
else
    PARENTPROC="process $PARENTPID (appears already gone)"
fi

echo "$(date -u +"%FT%T.%3NZ") $$: $PARENTPROC called docker-compose-adsb $@"

# Acquire lock to prevent concurrent operations
exec 9>>"$LOCKFILE"

if ! flock --exclusive --nonblock 9; then
    echo "$(date -u +"%FT%T.%3NZ") $$: docker-compose-adsb will wait for lock"
    flock --exclusive 9
    echo "$(date -u +"%FT%T.%3NZ") $$: docker-compose-adsb finished waiting for lock"
fi

# Change to config directory
cd "$CONFIG_DIR" || {
    echo "Error: Config directory not found: $CONFIG_DIR"
    exit 1
}

# Determine docker compose command (newer plugin vs older standalone)
DOCKER_COMPOSE="docker compose"
$DOCKER_COMPOSE version &> /dev/null || DOCKER_COMPOSE="docker-compose"

# Check if base configuration is finished
if grep "_IS_BASE_CONFIG_FINISHED=True" "$ENV_FILE" > /dev/null 2>&1; then
    # Source the default compose files builder
    source "$CONFIG_DIR/default.docker-compose"
    
    echo "$(date -u +"%FT%T.%3NZ") $$: $DOCKER_COMPOSE ${COMPOSE_FILES[@]} $@"
    
    success="false"
    
    # Try up to 3 times (third time's a charm)
    for i in {1..3}; do
        $DOCKER_COMPOSE "${COMPOSE_FILES[@]}" "$@" && success="true" && break
    done
    
    # Handle specific commands
    if [ "$1" = "up" ]; then
        if [[ $success != true && "$DOCKER_COMPOSE" == "docker-compose" ]]; then
            # Last ditch effort with older docker-compose
            $DOCKER_COMPOSE "${COMPOSE_FILES[@]}" down -t 30
            $DOCKER_COMPOSE "${COMPOSE_FILES[@]}" "$@" && success="true"
        fi
        
        if [[ $success == true ]]; then
            rm -f "$BASE_DIR/state/compose_up_failed"
            echo "$(date -u +"%FT%T.%3NZ") $$: finished docker compose up"
        else
            touch "$BASE_DIR/state/compose_up_failed"
            echo "$(date -u +"%FT%T.%3NZ") $$: ERROR: docker compose up failed 3x"
            (
                echo "Docker thinks these containers are running:"
                docker ps
                echo "Docker thinks these networks are defined:"
                docker network ls
            ) >&2
        fi
    fi
else
    echo "$(date -u +"%FT%T.%3NZ") $$: Base configuration not finished yet"
    echo "Only minimal services will be started"
    
    # For argument "pull", pull the base ultrafeeder image
    if [[ "$1" == "pull" ]]; then
        echo "$(date -u +"%FT%T.%3NZ") $$: Pulling base images"
        for i in {1..3}; do
            if [ -f "$BASE_DIR/docker.image.versions" ]; then
                docker pull "$(grep ULTRAFEEDER_CONTAINER $BASE_DIR/docker.image.versions | cut -d= -f2)" && break
            fi
        done
    fi
fi
