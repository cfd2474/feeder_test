<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starting Services - TAKNET-PS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .loading-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
        }
        
        .loading-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-log {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .status-line {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .status-icon {
            font-size: 1.2em;
            min-width: 25px;
        }
        
        .status-pending { color: #fbbf24; }
        .status-success { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-info { color: #3b82f6; }
        
        .progress-bar-container {
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .progress-bar-label {
            font-size: 13px;
            color: #e5e7eb;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #374151;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .progress-fill-service {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .completion-message {
            display: none;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .completion-message h2 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }
        
        .completion-message p {
            margin: 10px 0;
            font-size: 1.1em;
        }
        
        .redirect-info {
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ©Ô∏è TAKNET-PS-ADSB-Feeder</h1>
        </header>

        <div class="loading-container">
            <div class="loading-header">
                <div class="spinner" id="spinner"></div>
                <h2>Starting Your Feeder...</h2>
                <p class="text-muted">Please wait while we configure and start the services</p>
            </div>

            <!-- Overall Progress -->
            <div class="progress-bar-container">
                <div class="progress-bar-label">Overall Progress</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">
                        <span id="progressText">0%</span>
                    </div>
                </div>
            </div>

            <!-- Current Service Progress -->
            <div class="progress-bar-container">
                <div class="progress-bar-label" id="serviceLabel">Current Service</div>
                <div class="progress-bar">
                    <div class="progress-fill progress-fill-service" id="serviceFill" style="width: 0%">
                        <span id="serviceText">Ready</span>
                    </div>
                </div>
            </div>

            <div class="status-log" id="statusLog">
                <div class="status-line status-pending">
                    <span class="status-icon">‚è≥</span>
                    <span>Initializing setup...</span>
                </div>
            </div>

            <div class="completion-message" id="completionMessage">
                <h2>‚úÖ Setup Complete!</h2>
                <p>Your TAKNET-PS feeder is now running</p>
                <p class="redirect-info">Redirecting to dashboard in <span id="countdown">3</span> seconds...</p>
            </div>
        </div>
    </div>

    <script>
        const statusLog = document.getElementById('statusLog');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const serviceFill = document.getElementById('serviceFill');
        const serviceText = document.getElementById('serviceText');
        const serviceLabel = document.getElementById('serviceLabel');
        const completionMessage = document.getElementById('completionMessage');
        const spinner = document.getElementById('spinner');
        
        let currentProgress = 0;
        const totalSteps = 6;
        
        function addStatusLine(icon, message, type) {
            const line = document.createElement('div');
            line.className = `status-line status-${type}`;
            line.innerHTML = `
                <span class="status-icon">${icon}</span>
                <span>${message}</span>
            `;
            statusLog.appendChild(line);
            statusLog.scrollTop = statusLog.scrollHeight;
        }
        
        function updateProgress(step) {
            currentProgress = (step / totalSteps) * 100;
            progressFill.style.width = currentProgress + '%';
            progressText.textContent = Math.round(currentProgress) + '%';
        }
        
        function updateServiceProgress(label, percent, text) {
            serviceLabel.textContent = label;
            serviceFill.style.width = percent + '%';
            serviceText.textContent = text;
        }
        
        function resetServiceProgress() {
            updateServiceProgress('Current Service', 0, 'Ready');
        }
        
        async function startSetup() {
            try {
                // Step 1: Read saved configuration
                updateServiceProgress('Step 1: Configuration', 0, 'Loading...');
                addStatusLine('üìã', 'Loading configuration...', 'pending');
                const configResponse = await fetch('/api/config');
                if (!configResponse.ok) throw new Error('Failed to load configuration');
                const config = await configResponse.json();
                updateServiceProgress('Step 1: Configuration', 100, 'Complete');
                addStatusLine('‚úì', `Feeder: ${config.MLAT_SITE_NAME || 'TAK-Feeder'}`, 'success');
                updateProgress(1);
                resetServiceProgress();
                
                // Step 2: Install & Configure Tailscale (if enabled)
                if (config.TAILSCALE_ENABLED === 'true' && config.TAILSCALE_AUTH_KEY) {
                    updateServiceProgress('Step 2: Tailscale VPN', 0, 'Checking...');
                    addStatusLine('üîê', 'Checking for Tailscale...', 'pending');
                    
                    try {
                        updateServiceProgress('Step 2: Tailscale VPN', 25, 'Downloading...');
                        const tailscaleResponse = await fetch('/api/tailscale/install', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                auth_key: config.TAILSCALE_AUTH_KEY,
                                hostname: config.MLAT_SITE_NAME
                            })
                        });
                        
                        updateServiceProgress('Step 2: Tailscale VPN', 75, 'Configuring...');
                        const tailscaleResult = await tailscaleResponse.json();
                        
                        if (tailscaleResult.success) {
                            updateServiceProgress('Step 2: Tailscale VPN', 100, 'Connected');
                            addStatusLine('‚úì', 'Tailscale VPN installed and configured', 'success');
                            addStatusLine('‚Ñπ', 'Connected to Tailscale network', 'info');
                        } else {
                            updateServiceProgress('Step 2: Tailscale VPN', 100, 'Skipped');
                            addStatusLine('‚ö†', `Tailscale setup had issues: ${tailscaleResult.message}`, 'info');
                            addStatusLine('‚Ñπ', 'Continuing with public IP fallback', 'info');
                        }
                    } catch (error) {
                        updateServiceProgress('Step 2: Tailscale VPN', 100, 'Skipped');
                        addStatusLine('‚ö†', 'Tailscale installation failed', 'info');
                        addStatusLine('‚Ñπ', 'Continuing with public IP fallback', 'info');
                    }
                } else if (config.TAILSCALE_ENABLED === 'true') {
                    addStatusLine('‚Ñπ', 'Tailscale enabled but no auth key provided', 'info');
                }
                updateProgress(2);
                resetServiceProgress();
                
                // Step 3: Build configuration
                updateServiceProgress('Step 3: Config Builder', 0, 'Generating...');
                addStatusLine('üîß', 'Building ultrafeeder configuration...', 'pending');
                await sleep(1000);
                updateServiceProgress('Step 3: Config Builder', 100, 'Complete');
                addStatusLine('‚úì', 'TAKNET-PS feed configured (Primary + Fallback)', 'success');
                addStatusLine('‚úì', 'MLAT feed configured', 'success');
                updateProgress(3);
                resetServiceProgress();
                
                // Step 4: Restart service
                updateServiceProgress('Step 4: Ultrafeeder', 0, 'Starting...');
                addStatusLine('üîÑ', 'Starting ultrafeeder service...', 'pending');
                addStatusLine('‚Ñπ', 'First start may take 1-2 minutes (downloading Docker images)', 'info');
                
                const restartResponse = await fetch('/api/service/restart', {
                    method: 'POST'
                });
                
                if (!restartResponse.ok) {
                    const error = await restartResponse.json();
                    throw new Error(error.message || 'Failed to restart service');
                }
                
                // Poll for ultrafeeder to be ready (max 3 minutes)
                updateServiceProgress('Step 4: Ultrafeeder', 10, 'Waiting...');
                addStatusLine('‚Ñπ', 'Waiting for ultrafeeder to start...', 'info');
                const maxWaitTime = 180000; // 3 minutes
                const pollInterval = 2000; // Check every 2 seconds for more responsive updates
                const startTime = Date.now();
                let isReady = false;
                let lastProgressUpdate = 0;
                let lastLoggedPercent = 0;
                
                while (!isReady && (Date.now() - startTime) < maxWaitTime) {
                    await sleep(pollInterval);
                    
                    try {
                        // Query REAL progress from backend
                        const progressResponse = await fetch('/api/service/progress');
                        const progressData = await progressResponse.json();
                        
                        // Check if service is ready
                        const statusResponse = await fetch('/api/service/ready');
                        const statusData = await statusResponse.json();
                        
                        if (statusData.ready) {
                            isReady = true;
                            updateServiceProgress('Step 4: Ultrafeeder', 100, 'Running');
                            addStatusLine('‚úì', 'Ultrafeeder container is running', 'success');
                        } else if (progressData.service === 'ultrafeeder') {
                            // Use REAL progress from backend
                            const percent = progressData.progress || 10;
                            const statusText = progressData.status || 'Starting...';
                            const details = progressData.details || '';
                            
                            // Update service progress bar with REAL data
                            updateServiceProgress('Step 4: Ultrafeeder', percent, details || statusText);
                            
                            // Only show progress in log when percent changes significantly (every 20%)
                            if (Math.floor(percent / 20) > Math.floor(lastLoggedPercent / 20)) {
                                addStatusLine('‚è≥', `${statusText} ${details}`, 'info');
                                lastLoggedPercent = percent;
                            }
                        } else {
                            // Fallback if progress API not responding
                            const elapsed = Math.floor((Date.now() - startTime) / 1000);
                            const fallbackProgress = Math.min(80, 10 + (elapsed / 180) * 70);
                            updateServiceProgress('Step 4: Ultrafeeder', fallbackProgress, `${elapsed}s elapsed`);
                            
                            if (elapsed - lastProgressUpdate >= 10) {
                                addStatusLine('‚è≥', `Still downloading/starting... (${elapsed}s elapsed)`, 'info');
                                lastProgressUpdate = elapsed;
                            }
                        }
                    } catch (error) {
                        // If status check fails, keep waiting
                        console.log('Status/progress check failed, retrying...', error);
                    }
                }
                
                if (!isReady) {
                    throw new Error('Ultrafeeder did not start within 3 minutes. This is usually caused by slow network or Docker issues. Check: journalctl -u ultrafeeder');
                }
                
                addStatusLine('‚úì', 'Ultrafeeder service started successfully', 'success');
                updateProgress(4);
                resetServiceProgress();
                
                // Step 5: Start FR24 if enabled
                if (config.FR24_ENABLED === 'true' && config.FR24_SHARING_KEY) {
                    updateServiceProgress('Step 5: FlightRadar24', 0, 'Starting...');
                    addStatusLine('üì°', 'Starting FlightRadar24 feeder...', 'pending');
                    await sleep(2000);
                    updateServiceProgress('Step 5: FlightRadar24', 100, 'Running');
                    addStatusLine('‚úì', 'FR24 container started', 'success');
                }
                updateProgress(5);
                resetServiceProgress();
                
                // Step 6: Verify
                updateServiceProgress('Step 6: Verification', 0, 'Checking...');
                addStatusLine('üîç', 'Verifying service status...', 'pending');
                await sleep(3000);
                updateServiceProgress('Step 6: Verification', 100, 'Complete');
                addStatusLine('‚úì', 'Services are running', 'success');
                addStatusLine('‚Ñπ', 'Connected to TAKNET-PS aggregator', 'info');
                addStatusLine('‚Ñπ', 'Note: Full synchronization may take a few more minutes', 'info');
                updateProgress(6);
                resetServiceProgress();
                
                // Complete
                await sleep(500);
                spinner.style.display = 'none';
                completionMessage.style.display = 'block';
                
                // Countdown and redirect
                let countdown = 3;
                const countdownEl = document.getElementById('countdown');
                const countdownInterval = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        window.location.href = '/dashboard';
                    }
                }, 1000);
                
            } catch (error) {
                addStatusLine('‚úó', `Error: ${error.message}`, 'error');
                addStatusLine('‚Ñπ', 'You can continue setup manually from the dashboard', 'info');
                spinner.style.display = 'none';
                
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 5000);
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Start setup on page load
        window.addEventListener('DOMContentLoaded', startSetup);
    </script>
</body>
</html>
