<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAKNET-PS-ADSB Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ©Ô∏è TAKNET-PS-ADSB-Feeder</h1>
            <p style="margin: 5px 0 5px 0; color: #9ca3af; font-size: 0.9em;">Tactical Awareness Kit Network for Enhanced Tracking ‚Äì Public Safety</p>
            <p style="margin: 0 0 15px 0; color: #6b7280; font-size: 0.8em;">v{{ version }}</p>
            <nav>
                <a href="/dashboard" class="active">Dashboard</a>
                <a href="/settings">Settings</a>
                <a href="/logs">Logs</a>
                <a href="http://{{ request.host.split(':')[0] }}:8080" target="_blank">Map</a>
                <button onclick="refreshDashboard()" class="btn btn-sm" style="margin-left: auto;">üîÑ Refresh</button>
            </nav>
        </header>

        <div class="dashboard">
            <!-- Status Cards -->
            <div class="card-grid">
                <div class="card">
                    <h3>Core Service</h3>
                    <div id="container-status">
                        {% if docker.get('ultrafeeder') %}
                            <div class="status-item">
                                <span class="status-dot {% if 'Up' in docker.get('ultrafeeder') %}active{% else %}inactive{% endif %}"></span>
                                <span>ultrafeeder</span>
                                <span class="status-text">{{ docker.get('ultrafeeder', 'Unknown') }}</span>
                            </div>
                        {% else %}
                            <p class="text-muted">ultrafeeder not running</p>
                        {% endif %}
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <p style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">Feeder UUID:</p>
                            <p style="font-family: monospace; font-size: 0.9em; color: #374151; word-break: break-all;">{{ feeder_uuid }}</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Location</h3>
                    <p><strong>Lat:</strong> {{ config.get('FEEDER_LAT', 'Not set') }}</p>
                    <p><strong>Lon:</strong> {{ config.get('FEEDER_LONG', 'Not set') }}</p>
                    <p><strong>Alt:</strong> {{ config.get('FEEDER_ALT_M', 'Not set') }}m</p>
                    <p><strong>TZ:</strong> {{ config.get('FEEDER_TZ', 'UTC') }}</p>
                </div>

                <div class="card">
                    <h3>Network Status</h3>
                    <div class="status-item" style="margin-bottom: 10px;">
                        <span class="status-label">Internet:</span>
                        <span id="internet-status" class="status-value">
                            <span class="status-dot"></span>
                            <span class="status-text">Checking...</span>
                        </span>
                    </div>
                    <div class="status-item" style="margin-bottom: 10px;">
                        <span class="status-label">IP Address:</span>
                        <span id="ip-address" class="status-value">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Hostname:</span>
                        <span id="hostname" class="status-value">Loading...</span>
                    </div>
                </div>

            <!-- Aggregator Feed Status Table -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>You are feeding</h3>
                <p style="color: #6b7280; font-size: 0.9em; margin-bottom: 15px;">
                    Enabled indicates feeding the aggregator. <span style="color: #10b981;">‚úì</span> feed is in good state, 
                    <span style="color: #ef4444;">‚úì</span> feed is down, <span style="color: #f59e0b;">‚úì</span> MLAT is down, 
                    <span style="color: #374151;">‚úì</span> if we don't have that information.
                </p>
                <p style="color: #6b7280; font-size: 0.9em; margin-bottom: 20px;">
                    '+' or '-' in the Data and MLAT columns show that aggregator indicates that you are (or are not) feeding ADS-B data and MLAT data to them.<br>
                    '.' in those columns indicates that the aggregator isn't offering that information to the feeder.
                </p>
                
                <div style="overflow-x: auto;">
                    <table class="feed-table">
                        <thead>
                            <tr>
                                <th>Aggregator</th>
                                <th style="text-align: center;">Enabled</th>
                                <th style="text-align: center;">Data</th>
                                <th style="text-align: center;">MLAT</th>
                                <th style="text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="feed-table-body">
                            {% if config.get('TAKNET_PS_ENABLED') == 'true' %}
                            <tr>
                                <td><strong>TAKNET-PS Server</strong></td>
                                <td style="text-align: center;"><span class="feed-check" id="taknet-check" data-status="good">‚úì</span></td>
                                <td style="text-align: center;" id="taknet-data">+</td>
                                <td style="text-align: center;" id="taknet-mlat">{{ '+' if config.get('TAKNET_PS_MLAT_ENABLED') == 'true' else '-' }}</td>
                                <td style="text-align: center;"><a href="#" class="feed-link">üîó</a></td>
                            </tr>
                            {% endif %}
                            
                            {% if config.get('FR24_ENABLED') == 'true' %}
                            <tr>
                                <td>FlightRadar24</td>
                                <td style="text-align: center;"><span class="feed-check" id="fr24-check" data-status="unknown">‚úì</span></td>
                                <td style="text-align: center;" id="fr24-data">.</td>
                                <td style="text-align: center;" id="fr24-mlat">.</td>
                                <td style="text-align: center;"><a href="#" class="feed-link">üîó</a></td>
                            </tr>
                            {% endif %}
                            
                            {% if config.get('ADSBFI_ENABLED') == 'true' %}
                            <tr>
                                <td>adsb.fi</td>
                                <td style="text-align: center;"><span class="feed-check" id="adsbfi-check" data-status="good">‚úì</span></td>
                                <td style="text-align: center;">.</td>
                                <td style="text-align: center;">.</td>
                                <td style="text-align: center;"><a href="#" class="feed-link">üîó</a></td>
                            </tr>
                            {% endif %}
                            
                            {% if config.get('ADSBLOL_ENABLED') == 'true' %}
                            <tr>
                                <td>adsb.lol</td>
                                <td style="text-align: center;"><span class="feed-check" id="adsblol-check" data-status="good">‚úì</span></td>
                                <td style="text-align: center;">.</td>
                                <td style="text-align: center;">.</td>
                                <td style="text-align: center;"><a href="#" class="feed-link">üîó</a></td>
                            </tr>
                            {% endif %}
                            
                            {% if config.get('AIRPLANESLIVE_ENABLED') == 'true' %}
                            <tr>
                                <td>Airplanes.Live</td>
                                <td style="text-align: center;"><span class="feed-check" id="airplaneslive-check" data-status="good">‚úì</span></td>
                                <td style="text-align: center;">.</td>
                                <td style="text-align: center;">.</td>
                                <td style="text-align: center;"><a href="#" class="feed-link">üîó</a></td>
                            </tr>
                            {% endif %}
                            
                            {% if not config.get('TAKNET_PS_ENABLED') and not config.get('FR24_ENABLED') and not config.get('ADSBFI_ENABLED') and not config.get('ADSBLOL_ENABLED') and not config.get('AIRPLANESLIVE_ENABLED') %}
                            <tr>
                                <td colspan="5" style="text-align: center; color: #9ca3af; padding: 20px;">
                                    No feeds configured
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-primary" onclick="restartService()">üîÑ Restart Service</button>
                <button class="btn" onclick="window.location.href='/settings'">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <style>
        header nav {
            display: flex;
            align-items: center;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-sm:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-sm:active {
            transform: translateY(0);
        }
        
        .refreshing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .last-updated {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>

    <div class="last-updated" id="lastUpdated">
        Last updated: <span id="updateTime">Just now</span>
    </div>

    <script src="/static/js/dashboard.js"></script>
    <script>
        let autoRefreshInterval;
        let serviceStateInterval;
        let lastUpdateTime = new Date();
        
        async function updateServiceStates() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update TAKNET-PS feed table status (based on ultrafeeder)
                if (data.service_states && data.service_states.ultrafeeder) {
                    const ultrafeederState = data.service_states.ultrafeeder;
                    const taknetCheck = document.getElementById('taknet-check');
                    
                    if (taknetCheck) {
                        switch(ultrafeederState) {
                            case 'running':
                                taknetCheck.setAttribute('data-status', 'good');
                                break;
                            case 'starting':
                                taknetCheck.setAttribute('data-status', 'unknown');
                                break;
                            case 'stopped':
                            case 'not_installed':
                                taknetCheck.setAttribute('data-status', 'down');
                                break;
                        }
                    }
                }
                
                // Update FR24 feed table status if enabled
                if (data.service_states && data.service_states.fr24) {
                    const fr24State = data.service_states.fr24;
                    const fr24Check = document.getElementById('fr24-check');
                    
                    if (fr24Check) {
                        switch(fr24State) {
                            case 'running':
                                fr24Check.setAttribute('data-status', 'good');
                                break;
                            case 'downloading':
                            case 'starting':
                                fr24Check.setAttribute('data-status', 'unknown');
                                break;
                            case 'stopped':
                            case 'not_installed':
                                fr24Check.setAttribute('data-status', 'down');
                                break;
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to update service states:', error);
            }
        }
        
        function refreshDashboard() {
            const btn = event ? event.target : null;
            if (btn) {
                btn.classList.add('refreshing');
                btn.disabled = true;
            }
            
            // Reload the page
            location.reload();
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const seconds = Math.floor((now - lastUpdateTime) / 1000);
            
            let timeText;
            if (seconds < 60) {
                timeText = `${seconds}s ago`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                timeText = `${minutes}m ago`;
            } else {
                const hours = Math.floor(seconds / 3600);
                timeText = `${hours}h ago`;
            }
            
            document.getElementById('updateTime').textContent = timeText;
        }
        
        // Auto-refresh every 10 seconds
        function startAutoRefresh() {
            // Update time display every second
            setInterval(updateLastUpdateTime, 1000);
            
            // Update service states every 3 seconds (more responsive)
            serviceStateInterval = setInterval(updateServiceStates, 3000);
            
            // Auto-refresh page every 10 seconds
            autoRefreshInterval = setInterval(() => {
                console.log('Auto-refreshing dashboard...');
                location.reload();
            }, 10000);
        }
        
        // Start auto-refresh when page loads
        window.addEventListener('DOMContentLoaded', () => {
            lastUpdateTime = new Date();
            updateLastUpdateTime();
            updateServiceStates(); // Initial update
            startAutoRefresh();
        });
        
        // Clear interval when leaving page
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (serviceStateInterval) {
                clearInterval(serviceStateInterval);
            }
        });
    </script>
</body>
</html>
