<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAKNET-PS-ADSB Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ©Ô∏è TAKNET-PS-ADSB-Feeder</h1>
            <p style="margin: 5px 0 15px 0; color: #9ca3af; font-size: 0.9em;">Tactical Awareness Kit Network for Enhanced Tracking ‚Äì Public Safety</p>
            <nav>
                <a href="/dashboard" class="active">Dashboard</a>
                <a href="/settings">Settings</a>
                <a href="/logs">Logs</a>
                <a href="http://{{ request.host.split(':')[0] }}:8080" target="_blank">Map</a>
                <button onclick="refreshDashboard()" class="btn btn-sm" style="margin-left: auto;">üîÑ Refresh</button>
            </nav>
        </header>

        <div class="dashboard">
            <!-- Status Cards -->
            <div class="card-grid">
                <div class="card">
                    <h3>Container Status</h3>
                    <div id="container-status">
                        {% if docker.get('ultrafeeder') %}
                            <div class="status-item">
                                <span class="status-dot {% if 'Up' in docker.get('ultrafeeder') %}active{% else %}inactive{% endif %}"></span>
                                <span>ultrafeeder</span>
                                <span class="status-text">{{ docker.get('ultrafeeder', 'Unknown') }}</span>
                            </div>
                        {% else %}
                            <p class="text-muted">ultrafeeder not running</p>
                        {% endif %}
                        
                        {% if config.get('FR24_ENABLED') == 'true' %}
                            <div class="status-item">
                                <span class="status-dot" id="fr24-status-dot"></span>
                                <span>fr24</span>
                                <span class="status-text" id="fr24-status-text">Checking...</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card">
                    <h3>Location</h3>
                    <p><strong>Lat:</strong> {{ config.get('FEEDER_LAT', 'Not set') }}</p>
                    <p><strong>Lon:</strong> {{ config.get('FEEDER_LONG', 'Not set') }}</p>
                    <p><strong>Alt:</strong> {{ config.get('FEEDER_ALT_M', 'Not set') }}m</p>
                    <p><strong>TZ:</strong> {{ config.get('FEEDER_TZ', 'UTC') }}</p>
                </div>

                <div class="card">
                    <h3>Network Status</h3>
                    <div class="status-item" style="margin-bottom: 10px;">
                        <span class="status-label">Internet:</span>
                        <span id="internet-status" class="status-value">
                            <span class="status-dot"></span>
                            <span class="status-text">Checking...</span>
                        </span>
                    </div>
                    <div class="status-item" style="margin-bottom: 10px;">
                        <span class="status-label">IP Address:</span>
                        <span id="ip-address" class="status-value">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Hostname:</span>
                        <span id="hostname" class="status-value">Loading...</span>
                    </div>
                </div>

                <div class="card">
                    <h3>Active Feeds</h3>
                    <div id="active-feeds">
                        {% if config.get('TAKNET_PS_ENABLED') == 'true' %}
                            <div class="feed-item">
                                <span class="status-dot active"></span>
                                <div>
                                    <strong>TAKNET-PS Server</strong>
                                    <div style="font-size: 0.85em; color: #9ca3af; margin-top: 2px;">
                                        {% if config.get('TAKNET_PS_SERVER_HOST_PRIMARY') %}
                                            Primary: {{ config.get('TAKNET_PS_SERVER_HOST_PRIMARY') }}:{{ config.get('TAKNET_PS_SERVER_PORT', '30004') }}
                                        {% endif %}
                                    </div>
                                    {% if config.get('TAKNET_PS_MLAT_ENABLED') == 'true' %}
                                        <div style="font-size: 0.85em; color: #9ca3af;">
                                            MLAT: {{ config.get('TAKNET_PS_SERVER_HOST_PRIMARY') }}:{{ config.get('TAKNET_PS_MLAT_PORT', '30105') }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                        {% if config.get('FR24_ENABLED') == 'true' %}
                            <div class="feed-item">
                                <span class="status-dot active"></span>
                                FlightRadar24
                            </div>
                        {% endif %}
                        {% if config.get('ADSBX_ENABLED') == 'true' %}
                            <div class="feed-item">
                                <span class="status-dot active"></span>
                                ADS-B Exchange
                            </div>
                        {% endif %}
                        {% if config.get('AIRPLANESLIVE_ENABLED') == 'true' %}
                            <div class="feed-item">
                                <span class="status-dot active"></span>
                                Airplanes.Live
                            </div>
                        {% endif %}
                        {% if not config.get('TAKNET_PS_ENABLED') and not config.get('FR24_ENABLED') and not config.get('ADSBX_ENABLED') and not config.get('AIRPLANESLIVE_ENABLED') %}
                            <p class="text-muted">No feeds configured</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-primary" onclick="restartService()">üîÑ Restart Service</button>
                <button class="btn" onclick="window.location.href='/settings'">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <style>
        header nav {
            display: flex;
            align-items: center;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-sm:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-sm:active {
            transform: translateY(0);
        }
        
        .refreshing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .last-updated {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>

    <div class="last-updated" id="lastUpdated">
        Last updated: <span id="updateTime">Just now</span>
    </div>

    <script src="/static/js/dashboard.js"></script>
    <script>
        let autoRefreshInterval;
        let serviceStateInterval;
        let lastUpdateTime = new Date();
        
        async function updateServiceStates() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update FR24 status if enabled
                if (data.service_states && data.service_states.fr24) {
                    const fr24State = data.service_states.fr24;
                    const fr24Dot = document.getElementById('fr24-status-dot');
                    const fr24Text = document.getElementById('fr24-status-text');
                    
                    if (fr24Dot && fr24Text) {
                        switch(fr24State) {
                            case 'running':
                                fr24Dot.className = 'status-dot active';
                                fr24Text.textContent = 'Running';
                                break;
                            case 'downloading':
                                fr24Dot.className = 'status-dot' + ' inactive';
                                fr24Text.textContent = 'Downloading...';
                                fr24Text.style.color = '#f59e0b';
                                break;
                            case 'starting':
                                fr24Dot.className = 'status-dot inactive';
                                fr24Text.textContent = 'Starting...';
                                fr24Text.style.color = '#f59e0b';
                                break;
                            case 'stopped':
                                fr24Dot.className = 'status-dot inactive';
                                fr24Text.textContent = 'Not running';
                                fr24Text.style.color = '';
                                break;
                            case 'not_installed':
                                fr24Dot.className = 'status-dot inactive';
                                fr24Text.textContent = 'Not installed';
                                fr24Text.style.color = '#9ca3af';
                                break;
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to update service states:', error);
            }
        }
        
        function refreshDashboard() {
            const btn = event ? event.target : null;
            if (btn) {
                btn.classList.add('refreshing');
                btn.disabled = true;
            }
            
            // Reload the page
            location.reload();
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const seconds = Math.floor((now - lastUpdateTime) / 1000);
            
            let timeText;
            if (seconds < 60) {
                timeText = `${seconds}s ago`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                timeText = `${minutes}m ago`;
            } else {
                const hours = Math.floor(seconds / 3600);
                timeText = `${hours}h ago`;
            }
            
            document.getElementById('updateTime').textContent = timeText;
        }
        
        // Auto-refresh every 10 seconds
        function startAutoRefresh() {
            // Update time display every second
            setInterval(updateLastUpdateTime, 1000);
            
            // Update service states every 3 seconds (more responsive)
            serviceStateInterval = setInterval(updateServiceStates, 3000);
            
            // Auto-refresh page every 10 seconds
            autoRefreshInterval = setInterval(() => {
                console.log('Auto-refreshing dashboard...');
                location.reload();
            }, 10000);
        }
        
        // Start auto-refresh when page loads
        window.addEventListener('DOMContentLoaded', () => {
            lastUpdateTime = new Date();
            updateLastUpdateTime();
            updateServiceStates(); // Initial update
            startAutoRefresh();
        });
        
        // Clear interval when leaving page
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (serviceStateInterval) {
                clearInterval(serviceStateInterval);
            }
        });
    </script>
</body>
</html>
